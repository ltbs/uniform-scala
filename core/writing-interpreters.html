<html><head><title>uniform-scala: Writing Interpreters</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Luke Tebbs" /><meta name="description" content="Purely functional user-interaction" /><meta name="og:image" content="/uniform-scala/img/poster.png" /><meta name="image" property="og:image" content="/uniform-scala/img/poster.png" /><meta name="og:title" content="uniform-scala: Writing Interpreters" /><meta name="title" property="og:title" content="uniform-scala: Writing Interpreters" /><meta name="og:site_name" content="uniform-scala" /><meta name="og:url" content="https://ltbs.github.io/uniform-scala/" /><meta name="og:type" content="website" /><meta name="og:description" content="Purely functional user-interaction" /><link rel="icon" type="image/png" href="/uniform-scala/img/favicon.png" /><meta name="twitter:title" content="uniform-scala: Writing Interpreters" /><meta name="twitter:image" content="/uniform-scala/img/poster.png" /><meta name="twitter:description" content="Purely functional user-interaction" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/uniform-scala/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/uniform-scala/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/uniform-scala/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/uniform-scala/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/uniform-scala/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/uniform-scala/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/uniform-scala/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/uniform-scala/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/uniform-scala/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/uniform-scala/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/uniform-scala/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/uniform-scala/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/uniform-scala/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/uniform-scala/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/uniform-scala/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/uniform-scala/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/uniform-scala/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/uniform-scala/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/uniform-scala/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/uniform-scala/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/uniform-scala/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/uniform-scala/css/style.css" /><link rel="stylesheet" href="/uniform-scala/css/palette.css" /><link rel="stylesheet" href="/uniform-scala/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/uniform-scala/" class="brand"><div class="brand-wrapper"><span>uniform-scala</span></div></a></li> <li><a href="/uniform-scala/index.html" class="">Home</a></li> <li><a href="/uniform-scala/setup.html" class="">Setup</a></li> <li><a href="/uniform-scala/core/basic-program.html" class="">Writing a journey</a> <ul class="sub_section"> <li><a href="/uniform-scala/core/tells.html" class="">Telling</a></li> <li><a href="/uniform-scala/core/asks.html" class="">Asking</a></li> <li><a href="/uniform-scala/core/interacts.html" class="">Interacting</a></li> <li><a href="/uniform-scala/core/validation.html" class="">Validation</a></li> <li><a href="/uniform-scala/core/branching.html" class="">Branching</a></li> <li><a href="/uniform-scala/core/remote-calls.html" class="">Remote Calls</a></li></ul></li> <li><a href="/uniform-scala/play/index.html" class="">Play Framework Interpreter</a> <ul class="sub_section"> <li><a href="/uniform-scala/play/controllers.html" class="">Controllers</a></li> <li><a href="/uniform-scala/play/web-monad.html" class="">WebMonad</a></li> <li><a href="/uniform-scala/play/internationalisation.html" class="">Internationalisation</a></li> <li><a href="/uniform-scala/play/listing-pages.html" class="">Listing Pages</a></li> <li><a href="/uniform-scala/play/remote-calls.html" class="">Memoisation</a></li></ul></li> <li><a href="/uniform-scala/interpreters.html" class="">Other Interpreters</a> <ul class="sub_section"> <li><a href="/uniform-scala/interpreter-cli.html" class="">CLI Interpreter</a></li> <li><a href="/uniform-scala/interpreter-logic-table.html" class="">Logic Table Interpreter</a></li> <li><a href="/uniform-scala/interpreter-static-site.html" class="">Static Site interpreter</a></li> <li><a href="/uniform-scala/interpreter-selenium.html" class="">Selenium Interpreter</a></li></ul></li> <li><a href="/uniform-scala/core/advanced.html" class="">Advanced Options</a> <ul class="sub_section"> <li><a href="/uniform-scala/core/writing-interpreters.html" class=" active ">Writing Interpreters</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/ltbs/uniform-scala"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/ltbs/uniform-scala"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('uniform-scala Purely functional user-interaction');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('uniform-scala Purely functional user-interaction');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="ltbs" data-github-repo="uniform-scala"><div class="content-wrapper"><section><h1 id="writing-interpreters">Writing Interpreters</h1>

<p>So far we have discussed how to consume existing interpreters, this
section is meant to serve as a guide as to how to write your own interpreter.</p>

<p>This is not necessary (or recommended) for day-to-day usage of Uniform
but it opens up lots of possibilities should you have somewhat unusual
requirements.</p>

<h2 id="unnatural-transformations">Unnatural Transformations</h2>

<p>Uniform journeys are essentially tagless final programs with one
important twist - the methods accept type parameters. As such we
can call <code class="highlighter-rouge">ask[Int]</code> rather than needing <code class="highlighter-rouge">askInt</code>, <code class="highlighter-rouge">askString</code>, etc for
every possible datatype we might want to consume.</p>

<p>If we did have hundreds of <code class="highlighter-rouge">askN</code> methods one for every
possible datatype our interpreters would need to provide an
implementation of every datatype we wanted, we would need to
update the uniform language itself if we wanted to add a new type and
therefore every interpreter (if all other users wanted to use your new
datatype or not).</p>

<p>Using <code class="highlighter-rouge">ask[T]: UF[T]</code> presents its own problems however - when using tagless
final we transform our <code class="highlighter-rouge">UF[T]</code> into our desired datatype,
<code class="highlighter-rouge">WebMonad[T]</code> perhaps. <code class="highlighter-rouge">UF ⇝ WebMonad</code> is therefore the natural
transformation that is being applied.</p>

<p>But natural transformations are total - for every possible <code class="highlighter-rouge">A</code> we must
be able to convert <code class="highlighter-rouge">UF[A]</code> into <code class="highlighter-rouge">WebMonad[A]</code>. Therefore the only methods
we would be able to invoke for <code class="highlighter-rouge">A</code> are ones that belong to <code class="highlighter-rouge">Any</code> such
as <code class="highlighter-rouge">toString</code>.</p>

<p>Ordinarily we would add a typeclass to represent the support for a
given datatype, for example <code class="highlighter-rouge">ask[A: WebMonadSupport]</code> but then our
typeclasses are bound to the journey itself at compile time rather
than being specific to a given interpreter.</p>

<p>We need something that is <em>not quite</em> a natural transformation. Our
journey should be able to refer to any datatype it needs but the
typeclass instance should be owned and retrieved by the interpreter.</p>

<p>The journey must declare the types it uses, and the interpreter must
provide support for each datatype in the journey it interprets by way
of a typeclass. The journey must know nothing of the typeclasses used
by any given interpreter.</p>

<p>I found this to be a surprisingly difficult problem to solve, and
several techniques were explored in different versions of uniform.</p>

<p>The three approaches I found were to use the Eff monad (which is
effective but makes the syntax much more convoluted), using runtime
reflection (which prevents ScalaJS from working correctly) and the
current approach - using hetrogenous lists of typeclass instances
together with custom macros to inhibit type erasure.</p>

<p>Using the latest approach we do need a typeclass on the <code class="highlighter-rouge">ask</code> method
itself - simplified our language looks like this -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import shapeless.HList
import scala.language.higherKinds

trait Language[UF[_], SupportedAsk &lt;: HList]{

  def ask[A](id: String)(
    implicit selectorAsk : IndexOf[SupportedAsk, A]
  ): UF[A]

}
</code></pre></div></div>

<p>The <code class="highlighter-rouge">SupportedAsk</code> type is a plain shapeless <code class="highlighter-rouge">HList</code> of supported
types. The interpreter will map this into a <code class="highlighter-rouge">HList</code> of typeclass
instances - one <code class="highlighter-rouge">TC</code> for every element of <code class="highlighter-rouge">SupportedAsk</code>.</p>

<p>The <code class="highlighter-rouge">IndexOf</code> allows the interpreter to find the index of
the type <code class="highlighter-rouge">A</code> in <code class="highlighter-rouge">SupportedAsk</code>, this index is then used to find
<code class="highlighter-rouge">TC[A]</code> in the mapped hetrogenous list.</p>

<p>Suppose we want an interpreter that returns dummy values - for any
<code class="highlighter-rouge">ask[A]</code> it should return a canned value of type <code class="highlighter-rouge">A</code>.</p>

<p>We would create a typeclass like the following -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Example</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="k">def</span> <span class="n">value</span><span class="k">:</span> <span class="kt">A</span> <span class="o">}</span>
</code></pre></div></div>

<p>And we would now give some instances -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">val</span> <span class="n">intExample</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Example</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">{</span> <span class="k">def</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">}</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">stringExample</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Example</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">{</span> <span class="k">def</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"test"</span> <span class="o">}</span>
</code></pre></div></div>

<p>We can now create an interpreter. First we must decide what higher
kinded type our interpreter works with. To keep things simple we’re
just going to use the <code class="highlighter-rouge">Id</code> monad here.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">ltbs.uniform._</span>

<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.</span><span class="o">{</span><span class="nc">Id</span><span class="o">,</span> <span class="nc">Monad</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">shapeless.</span><span class="o">{</span><span class="nc">Id</span> <span class="k">⇒</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">scala.language.higherKinds</span>

<span class="k">class</span> <span class="nc">ExampleValuesInterpreter</span><span class="o">[</span><span class="kt">SupportedTell</span> <span class="k">&lt;:</span> <span class="kt">HList</span>, <span class="kt">SupportedAsk</span> <span class="k">&lt;:</span> <span class="kt">HList</span><span class="o">](</span>
  <span class="k">implicit</span> <span class="n">askSummoner</span><span class="k">:</span> <span class="kt">TypeclassList</span><span class="o">[</span><span class="kt">SupportedAsk</span>, <span class="kt">Example</span><span class="o">]</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">Language</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">SupportedTell</span>, <span class="kt">SupportedAsk</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">interact</span><span class="o">[</span><span class="kt">Tell</span>, <span class="kt">Ask</span><span class="o">](</span>
    <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">tell</span><span class="k">:</span> <span class="kt">Tell</span><span class="o">,</span>
    <span class="n">default</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Ask</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
    <span class="n">validation</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Ask</span><span class="o">]]]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">customContent</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="o">(</span><span class="kt">String</span>,<span class="kt">List</span><span class="o">[</span><span class="kt">Any</span><span class="o">])]</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span>
  <span class="o">)(</span>
    <span class="k">implicit</span> <span class="n">selectorTell</span> <span class="k">:</span> <span class="kt">IndexOf</span><span class="o">[</span><span class="kt">SupportedTell</span>, <span class="kt">Tell</span><span class="o">],</span>
      <span class="n">selectorAsk</span> <span class="k">:</span> <span class="kt">IndexOf</span><span class="o">[</span><span class="kt">SupportedAsk</span>, <span class="kt">Ask</span><span class="o">]</span>
  <span class="o">)</span><span class="k">:</span> <span class="kt">Id</span><span class="o">[</span><span class="kt">Ask</span><span class="o">]</span> <span class="k">=</span> <span class="n">askSummoner</span><span class="o">.</span><span class="n">forType</span><span class="o">[</span><span class="kt">Ask</span><span class="o">].</span><span class="n">value</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Because <code class="highlighter-rouge">ask</code> and <code class="highlighter-rouge">tell</code> are actually just invoking <code class="highlighter-rouge">interact</code> we only
need to define that method.</p>

<p><code class="highlighter-rouge">TypeclassList</code> is a special construct in uniform, for any <code class="highlighter-rouge">HList</code>
it will give you a mapped HList of its implicit typeclass
instances. For example if we use <code class="highlighter-rouge">Int</code> and <code class="highlighter-rouge">String</code> -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">summoner</span> <span class="k">=</span> <span class="nc">TypeclassList</span><span class="o">[</span><span class="kt">Int</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">HNil</span>, <span class="kt">Example</span><span class="o">]</span>
<span class="n">summoner</span><span class="k">:</span> <span class="kt">ltbs.uniform.TypeclassList</span><span class="o">[</span><span class="kt">Int</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">shapeless.HNil</span>,<span class="kt">Example</span><span class="o">]</span> <span class="k">=</span> <span class="n">ltbs</span><span class="o">.</span><span class="n">uniform</span><span class="o">.</span><span class="nc">TypeclassList$$anon$2</span><span class="k">@</span><span class="mi">149</span><span class="n">a4b29</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">summoner</span><span class="o">.</span><span class="n">forType</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">value</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">summoner</span><span class="o">.</span><span class="n">forType</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">value</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">test</span>
</code></pre></div></div>

<p>We can now create a simple program and test our new interpreter -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">TellTypes</span> <span class="o">=</span> <span class="nc">NilTypes</span>
<span class="k">type</span> <span class="kt">AskTypes</span> <span class="o">=</span> <span class="nc">Int</span> <span class="o">::</span> <span class="nc">String</span> <span class="o">::</span> <span class="nc">HNil</span>

<span class="k">def</span> <span class="n">program</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Monad</span><span class="o">](</span>
  <span class="n">interpreter</span><span class="k">:</span> <span class="kt">Language</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">TellTypes</span>, <span class="kt">AskTypes</span><span class="o">]</span>
<span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">interpreter._</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">a</span> <span class="k">←</span> <span class="n">ask</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"astring"</span><span class="o">)</span>
    <span class="n">b</span> <span class="k">←</span> <span class="n">ask</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"anint"</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">program</span><span class="o">(</span>
     <span class="o">|</span>   <span class="k">new</span> <span class="nc">ExampleValuesInterpreter</span><span class="o">[</span><span class="kt">TellTypes</span>, <span class="kt">AskTypes</span><span class="o">]</span>
     <span class="o">|</span> <span class="o">)</span>
<span class="n">res2</span><span class="k">:</span> <span class="kt">cats.Id</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="o">(</span><span class="n">test</span><span class="o">,</span><span class="mi">13</span><span class="o">)</span>
</code></pre></div></div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/uniform-scala/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/uniform-scala/js/main.js"></script></body></html>