<!DOCTYPE html><html><head><title>uniform-scala: Writing Interpreters</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Luke Tebbs" /><meta name="description" content="Purely functional user-interaction" /><meta name="og:image" content="/uniform-scala/img/poster.png" /><meta name="image" property="og:image" content="/uniform-scala/img/poster.png" /><meta name="og:title" content="uniform-scala: Writing Interpreters" /><meta name="title" property="og:title" content="uniform-scala: Writing Interpreters" /><meta name="og:site_name" content="uniform-scala" /><meta name="og:url" content="https://ltbs.github.io/uniform-scala/" /><meta name="og:type" content="website" /><meta name="og:description" content="Purely functional user-interaction" /><link rel="icon" type="image/png" href="/uniform-scala/img/favicon.png" /><meta name="twitter:title" content="uniform-scala: Writing Interpreters" /><meta name="twitter:image" content="/uniform-scala/img/poster.png" /><meta name="twitter:description" content="Purely functional user-interaction" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/uniform-scala/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/uniform-scala/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/uniform-scala/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/uniform-scala/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/uniform-scala/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/uniform-scala/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/uniform-scala/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/uniform-scala/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/uniform-scala/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/uniform-scala/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/uniform-scala/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/uniform-scala/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/uniform-scala/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/uniform-scala/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/uniform-scala/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/uniform-scala/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/uniform-scala/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/uniform-scala/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/uniform-scala/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/uniform-scala/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/uniform-scala/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/uniform-scala/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/uniform-scala/" class="brand"><div class="brand-wrapper"></div><span>uniform-scala</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/uniform-scala/index.html" title="Home" class="">Home</a></div> <div class="sidebar-nav-item  "><a href="/uniform-scala/setup.html" title="Setup" class="">Setup</a></div> <div class="sidebar-nav-item  "><a href="/uniform-scala/core/basic-program.html" title="Writing a journey" class="drop-nested">Writing a journey</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/uniform-scala/core/tells.html" title="Telling" class="">Telling</a> <a href="/uniform-scala/core/asks.html" title="Asking" class="">Asking</a> <a href="/uniform-scala/core/composition.html" title="Composition" class="">Composition</a> <a href="/uniform-scala/core/interacts.html" title="Interacting" class="">Interacting</a> <a href="/uniform-scala/core/branching.html" title="Branching" class="">Branching</a> <a href="/uniform-scala/core/subjourney.html" title="Subjourneys" class="">Subjourneys</a> <a href="/uniform-scala/core/remote-calls.html" title="Remote Calls" class="">Remote Calls</a></div></div> <div class="sidebar-nav-item  "><a href="/uniform-scala/interpreter-play27/index.html" title="Play Framework Interpreter" class="drop-nested">Play Framework Interpreter</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/uniform-scala/interpreter-play27/controllers.html" title="Controllers" class="">Controllers</a> <a href="/uniform-scala/interpreter-play27/alternative-templating.html" title="Alternative templating technologies" class="">Alternative templating technologies</a></div></div> <div class="sidebar-nav-item  "><a href="/uniform-scala/common-web/index.html" title="Generic Web Interpreters" class="drop-nested">Generic Web Interpreters</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/uniform-scala/common-web/web-monad.html" title="WebMonad" class="">WebMonad</a> <a href="/uniform-scala/common-web/internationalisation.html" title="Internationalisation" class="">Internationalisation</a> <a href="/uniform-scala/common-web/remote-calls.html" title="Memoisation" class="">Memoisation</a> <a href="/uniform-scala/common-web/derivation-of-views.html" title="Derivation of views" class="">Derivation of views</a></div></div> <div class="sidebar-nav-item  "><a href="/uniform-scala/interpreters.html" title="Other Interpreters" class="drop-nested">Other Interpreters</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/uniform-scala/interpreter-static-site.html" title="Static Site interpreter" class="">Static Site interpreter</a></div></div> <div class="sidebar-nav-item  "><a href="/uniform-scala/core/internationalisation.html" title="Internationalisation" class="">Internationalisation</a></div> <div class="sidebar-nav-item active "><a href="/uniform-scala/core/writing-interpreters.html" title="Writing Interpreters" class="active">Writing Interpreters</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/ltbs/uniform-scala" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/ltbs/uniform-scala" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="ltbs" data-github-repo="uniform-scala"><div class="content-wrapper"><section><h1 id="writing-interpreters">Writing Interpreters</h1>

<p>So far we have discussed how to consume existing interpreters, this
section is meant to serve as a guide as to how to write your own interpreter.</p>

<p>This is not necessary (or recommended) for day-to-day usage of Uniform
but it opens up lots of possibilities should you have somewhat unusual
requirements.</p>

<h2 id="unnatural-transformations">Unnatural Transformations</h2>

<p>Uniform journeys are essentially tagless final programs with one
important twist - the methods accept type parameters. As such we
can call <code class="language-plaintext highlighter-rouge">ask[Int]</code> rather than needing <code class="language-plaintext highlighter-rouge">askInt</code>, <code class="language-plaintext highlighter-rouge">askString</code>, etc for
every possible datatype we might want to consume.</p>

<p>If we did have hundreds of <code class="language-plaintext highlighter-rouge">askN</code> methods one for every
possible datatype our interpreters would need to provide an
implementation of every datatype we wanted, we would need to
update the uniform language itself if we wanted to add a new type and
therefore every interpreter (if all other users wanted to use your new
datatype or not).</p>

<p>Using <code class="language-plaintext highlighter-rouge">ask[T]: UF[T]</code> presents its own problems however - when using tagless
final we transform our <code class="language-plaintext highlighter-rouge">UF[T]</code> into our desired datatype,
<code class="language-plaintext highlighter-rouge">WebMonad[T]</code> perhaps. <code class="language-plaintext highlighter-rouge">UF ~&gt; WebMonad</code> is therefore the natural
transformation that is being applied.</p>

<p>But natural transformations are total - for every possible <code class="language-plaintext highlighter-rouge">A</code> we must
be able to convert <code class="language-plaintext highlighter-rouge">UF[A]</code> into <code class="language-plaintext highlighter-rouge">WebMonad[A]</code>. Therefore the only methods
we would be able to invoke for <code class="language-plaintext highlighter-rouge">A</code> are ones that belong to <code class="language-plaintext highlighter-rouge">Any</code> such
as <code class="language-plaintext highlighter-rouge">toString</code>.</p>

<p>Ordinarily we would add a typeclass to represent the support for a
given datatype, for example <code class="language-plaintext highlighter-rouge">ask[A: WebMonadSupport]</code> but then our
typeclasses are bound to the journey itself at compile time rather
than being specific to a given interpreter.</p>

<p>We need something that is <em>not quite</em> a natural transformation. Our
journey should be able to refer to any datatype it needs but the
typeclass instance should be owned and retrieved by the interpreter.</p>

<p>The journey must declare the types it uses, and the interpreter must
provide support for each datatype in the journey it interprets by way
of a typeclass. The journey must know nothing of the typeclasses used
by any given interpreter.</p>

<p>I found this to be a surprisingly difficult problem to solve, and
several techniques were explored in different versions of uniform.</p>

<p>The four approaches I found were -</p>

<ol>
  <li>use the Eff monad 
(effective but makes the syntax much more convoluted)</li>
  <li>using runtime reflection 
(prevents ScalaJS from working correctly)</li>
  <li>using hetrogenous lists of typeclass instances 
(works well, but leads to a complex syntax)</li>
  <li>using macros together with tags to inhibit type erasure
(the current approach)</li>
</ol>

<h2 id="monad-interpreters">Monad Interpreters</h2>

<p>The quickest and easiest type of interpreter to create is one based
off of monads. The interpreter will chain together the steps of the
journey into instances of your given datatype and then use <code class="language-plaintext highlighter-rouge">flatMap</code>
to bind them into each other.</p>

<p>When taking this approach you only need to specify how to map
interact, etc onto your chosen type.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">ltbs.uniform._</span>
<span class="k">import</span> <span class="nn">ltbs.uniform.validation.Rule</span>
<span class="k">import</span> <span class="nn">cats.</span><span class="o">{</span><span class="nc">Id</span><span class="o">,</span> <span class="nc">Monoid</span><span class="o">,</span> <span class="nc">Monad</span><span class="o">}</span>

<span class="c1">// we need to know how to tell and ask together
// we don't care about tell, and our ask is a Monoid
// so we just wrap the Monoid instance in a type
// with two parameters
</span><span class="k">case</span> <span class="k">class</span> <span class="nc">Zero</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">A</span><span class="o">](</span><span class="n">monoid</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="o">{</span> 
  <span class="k">def</span> <span class="n">value</span> <span class="k">=</span> <span class="n">monoid</span><span class="o">.</span><span class="n">empty</span>
<span class="o">}</span>

<span class="c1">// wherever there is an implicit Monoid we want an
// implicit Zero instance. 
</span><span class="k">implicit</span> <span class="k">def</span> <span class="n">zeroInstance</span><span class="o">[</span><span class="kt">T</span>,<span class="kt">A:</span> <span class="kt">Monoid</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Zero</span><span class="o">[</span><span class="kt">T</span>,<span class="kt">A</span><span class="o">](</span><span class="n">implicitly</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">ZeroInterpreter</span> <span class="k">extends</span> <span class="nc">MonadInterpreter</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">Zero</span>, <span class="kt">Noop</span><span class="o">]</span> <span class="o">{</span> 
  <span class="k">def</span> <span class="n">monadInstance</span> <span class="k">=</span> <span class="n">implicitly</span><span class="o">[</span><span class="kt">Monad</span><span class="o">[</span><span class="kt">Id</span><span class="o">]]</span>
  
  <span class="k">override</span> <span class="k">def</span> <span class="n">interactImpl</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">A</span><span class="o">](</span>
    <span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">tellValue</span><span class="k">:</span> <span class="kt">T</span><span class="o">,</span>
    <span class="n">default</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span>
    <span class="n">validation</span><span class="k">:</span> <span class="kt">Rule</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span>
    <span class="n">customContent</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="o">(</span><span class="kt">String</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">Any</span><span class="o">])],</span>
    <span class="n">interaction</span><span class="k">:</span> <span class="kt">Zero</span><span class="o">[</span><span class="kt">T</span>,<span class="kt">A</span><span class="o">]</span>
  <span class="o">)</span><span class="k">:</span> <span class="kt">Id</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">interaction</span><span class="o">.</span><span class="n">value</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">askListImpl</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span>
    <span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">askJourney</span><span class="k">:</span> <span class="o">(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="nc">List</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nc">Id</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span>
    <span class="n">default</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]],</span>
    <span class="n">validation</span><span class="k">:</span> <span class="kt">Rule</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]],</span>
    <span class="n">customContent</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="o">(</span><span class="kt">String</span>,<span class="kt">List</span><span class="o">[</span><span class="kt">Any</span><span class="o">])],</span>
    <span class="n">asker</span><span class="k">:</span> <span class="kt">Noop</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="o">)</span><span class="k">:</span> <span class="kt">Id</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Nil</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Lets create a simple journey in order to test our interpreter -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">journey</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">a</span> <span class="k">&lt;-</span> <span class="n">ask</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"a"</span><span class="o">)</span>
  <span class="n">c</span> <span class="k">&lt;-</span> <span class="n">ask</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"c"</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">c</span><span class="o">)</span>
</code></pre></div></div>

<p>We can now process the journey through the interpreter -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// we want an implicit instance of Monoid for String and Int
</span><span class="k">import</span> <span class="nn">cats.implicits._</span>  

<span class="c1">// run the journey using the interpreter
</span><span class="nc">ZeroInterpreter</span><span class="o">.</span><span class="n">interpret</span><span class="o">(</span><span class="n">journey</span><span class="o">)</span>
<span class="c1">// res0: (String, Int) = ("", 0)
</span></code></pre></div></div>
</section></div></div></div></div><script src="/uniform-scala/highlight/highlight.pack.js"></script><script src="/uniform-scala/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/uniform-scala/js/search.js"></script><script src="/uniform-scala/js/docs.js"></script></body></html>