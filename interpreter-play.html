<html><head><title>uniform-scala: Play Framework Interpreter</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Luke Tebbs" /><meta name="description" content="Purely functional user-interaction" /><meta name="og:image" content="/uniform-scala/img/poster.png" /><meta name="og:title" content="uniform-scala: Play Framework Interpreter" /><meta name="og:site_name" content="uniform-scala" /><meta name="og:url" content="https://ltbs.github.io/uniform-scala/" /><meta name="og:type" content="website" /><meta name="og:description" content="Purely functional user-interaction" /><link rel="icon" type="image/png" href="/uniform-scala/img/favicon.png" /><meta name="twitter:title" content="uniform-scala: Play Framework Interpreter" /><meta name="twitter:image" content="https://ltbs.github.io/uniform-scala/img/poster.png" /><meta name="twitter:description" content="Purely functional user-interaction" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/uniform-scala/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/uniform-scala/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/uniform-scala/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/uniform-scala/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/uniform-scala/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/uniform-scala/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/uniform-scala/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/uniform-scala/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/uniform-scala/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/uniform-scala/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/uniform-scala/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/uniform-scala/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/uniform-scala/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/uniform-scala/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/uniform-scala/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/uniform-scala/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/uniform-scala/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/uniform-scala/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/uniform-scala/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/uniform-scala/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/uniform-scala/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/uniform-scala/css/style.css" /><link rel="stylesheet" href="/uniform-scala/css/palette.css" /><link rel="stylesheet" href="/uniform-scala/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/uniform-scala/" class="brand"><div class="brand-wrapper"><span>uniform-scala</span></div></a></li> <li><a href="/uniform-scala/index.html" class="">Home</a></li> <li><a href="/uniform-scala/setup.html" class="">Setup</a></li> <li><a href="/uniform-scala/writing-a-program.html" class="">Writing a program</a></li> <li><a href="/uniform-scala/interpreters.html" class="">Interpreters</a> <ul class="sub_section"> <li><a href="/uniform-scala/interpreter-cli.html" class="">CLI Interpreter</a></li> <li><a href="/uniform-scala/interpreter-logic-table.html" class="">Logic Table Interpreter</a></li> <li><a href="/uniform-scala/interpreter-play.html" class=" active ">Play Framework Interpreter</a></li> <li><a href="/uniform-scala/interpreter-static-site.html" class="">Static Site interpreter</a></li> <li><a href="/uniform-scala/interpreter-selenium.html" class="">Selenium Interpreter</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/ltbs/uniform-scala"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/ltbs/uniform-scala"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('uniform-scala Purely functional user-interaction');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('uniform-scala Purely functional user-interaction');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="ltbs" data-github-repo="uniform-scala"><div class="content-wrapper"><section><h1 id="play-interpreter">Play Interpreter</h1>

<h2 id="setup">Setup</h2>

<p>If you are using play 2.6 you will need the following dependency in your build.sbt</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libraryDependencies +=
  "com.luketebbs.uniform" %% "interpreter-play26" % "0.2.4"
</code></pre></div></div>

<p>Or if you are using play 2.5 -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libraryDependencies +=
  "com.luketebbs.uniform" %% "interpreter-play25" % "0.2.4"
</code></pre></div></div>

<h2 id="controller-setup">Controller Setup</h2>

<p>Next you will need to extend your controller using <code class="highlighter-rouge">PlayController</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">ltbs.uniform.interpreters.playframework._</span>

<span class="k">import</span> <span class="nn">cats.Monoid</span>
<span class="k">import</span> <span class="nn">cats.data.Validated</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">concurrent.</span><span class="o">{</span><span class="nc">Future</span><span class="o">,</span> <span class="nc">ExecutionContext</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.atnos.eff._</span>
<span class="k">import</span> <span class="nn">play.api._</span><span class="o">,</span> <span class="n">mvc</span><span class="o">.</span><span class="k">_</span>
<span class="k">import</span> <span class="nn">play.api.data._</span><span class="o">,</span> <span class="nc">Forms</span><span class="o">.</span><span class="k">_</span>
<span class="k">import</span> <span class="nn">play.twirl.api.Html</span>

<span class="k">class</span> <span class="nc">ExampleController</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="k">with</span> <span class="nc">PlayInterpreter</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>

<p>This makes the common play interpreter available. But you will still need to
tell it how to ask the user any questions you need asked. These are contained in
the <code class="highlighter-rouge">WebMonadForm</code> class. If we use the
<code class="highlighter-rouge">GreasySpoon</code> program from the examples we need to be able to ask the user for
an <code class="highlighter-rouge">Int</code> and for a <code class="highlighter-rouge">Boolean</code> and as such we must provide an instance of
<code class="highlighter-rouge">WebMonadForm[Int]</code> and <code class="highlighter-rouge">WebMonadForm[Boolean]</code>. <code class="highlighter-rouge">WebMonadForm</code> has the
following structure -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trait WebMonadForm[T] {
  def encode(in: T): Encoded
  def decode(out: Encoded): T
  
  def playForm(
    key: String, 
    validation: T =&gt; Validated[ValidationError, T]
  ): Form[T]
  
  def render(
    key: String, 
    existing: ValidatedData[T], 
    request: Request[AnyContent]
  ): Html
}
</code></pre></div></div>

<p><code class="highlighter-rouge">Encoded</code> is just a type-alias for <code class="highlighter-rouge">String</code>. <code class="highlighter-rouge">encode</code> and <code class="highlighter-rouge">decode</code> are necessary so that uniform
can persist the data between requests. You could use Java serialisation here,
JSON encoding using <code class="highlighter-rouge">play-json</code> or perhaps one of the Scala pickling libraries.
For simplicity here weâ€™ll just roll our own.</p>

<p><code class="highlighter-rouge">render</code> defines how the form should appear, and <code class="highlighter-rouge">playForm</code> defines how the form
(and mapping) should be defined, and also how to hook in any validation defined
in the uniform journey itself.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExampleController2</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="k">with</span> <span class="nc">PlayInterpreter</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">ltbs.uniform.sampleprograms.GreasySpoon._</span>
  
  <span class="k">val</span> <span class="n">booleanForm</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WebMonadForm</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">{</span>
  
    <span class="k">def</span> <span class="n">decode</span><span class="o">(</span><span class="n">out</span><span class="k">:</span> <span class="kt">Encoded</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">out</span> <span class="o">==</span> <span class="s">"true"</span>
    <span class="k">def</span> <span class="n">encode</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Encoded</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="n">toString</span>
    
    <span class="k">def</span> <span class="n">playForm</span><span class="o">(</span>
      <span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> 
      <span class="n">validation</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=&gt;</span> <span class="nc">Validated</span><span class="o">[</span><span class="kt">ValidationError</span>,<span class="kt">Boolean</span><span class="o">]</span>
    <span class="o">)</span><span class="k">:</span> <span class="kt">Form</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Form</span><span class="o">(</span><span class="n">single</span><span class="o">(</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="n">boolean</span><span class="o">))</span>
    
    <span class="k">def</span> <span class="n">render</span><span class="o">(</span>
      <span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> 
      <span class="n">existing</span><span class="k">:</span> <span class="kt">ValidatedData</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">],</span> 
      <span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">[</span><span class="kt">AnyContent</span><span class="o">]</span>
    <span class="o">)</span><span class="k">:</span> <span class="kt">Html</span> <span class="o">=</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">form</span> <span class="k">=</span> <span class="n">existing</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">Validated</span><span class="o">.</span><span class="nc">Invalid</span><span class="o">(</span><span class="n">e</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">Form</span><span class="o">(</span><span class="n">single</span><span class="o">(</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="n">boolean</span><span class="o">)).</span><span class="n">withError</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
        <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Form</span><span class="o">(</span><span class="n">single</span><span class="o">(</span><span class="n">key</span> <span class="o">-&gt;</span> <span class="n">boolean</span><span class="o">))</span>
      <span class="o">}</span>

      <span class="o">???</span> <span class="c1">// replace with your view
</span>    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">intForm</span><span class="k">:</span> <span class="kt">WebMonadForm</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Next we need a persistence provider. Ordinarily weâ€™d have something keyed
against the session, or perhaps the users credentials if they are logged in.
This can be used to provide the capabilities for the user to log out and come
back later. For testing purposes however weâ€™ll just use a crude in-memory map.</p>

<p>Note that this combines data between ALL users - for obvious reasons you
shouldnâ€™t do this for a real service.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">type</span> <span class="kt">DB</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">String</span><span class="o">]</span>
<span class="n">defined</span> <span class="k">type</span> <span class="kt">alias</span> <span class="kt">DB</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">persistence</span><span class="o">(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Persistence</span> <span class="o">{</span>
     <span class="o">|</span>   <span class="k">private</span> <span class="k">var</span> <span class="n">data</span><span class="k">:</span> <span class="kt">DB</span> <span class="o">=</span> <span class="nc">Monoid</span><span class="o">[</span><span class="kt">DB</span><span class="o">].</span><span class="n">empty</span>
     <span class="o">|</span>   <span class="k">def</span> <span class="n">dataGet</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">DB</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
     <span class="o">|</span>   <span class="k">def</span> <span class="n">dataPut</span><span class="o">(</span><span class="n">dataIn</span><span class="k">:</span> <span class="kt">DB</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
     <span class="o">|</span>     <span class="nc">Future</span><span class="o">(</span><span class="n">data</span> <span class="k">=</span> <span class="n">dataIn</span><span class="o">).</span><span class="n">map</span><span class="o">{</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()}</span>
     <span class="o">|</span> <span class="o">}</span>
<span class="n">persistence</span><span class="k">:</span> <span class="o">(</span><span class="kt">implicit</span> <span class="kt">ec:</span> <span class="kt">scala.concurrent.ExecutionContext</span><span class="o">)</span><span class="kt">ltbs.uniform.interpreters.playframework.Persistence</span>
</code></pre></div></div>

<p>Now we have our persistence mechanism, we can construct the actual journey as
needed -</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ExampleController3</span><span class="o">(</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="k">with</span> <span class="nc">PlayInterpreter</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">ltbs.uniform.sampleprograms.GreasySpoon._</span>
  
  <span class="k">val</span> <span class="n">booleanForm</span><span class="k">:</span> <span class="kt">WebMonadForm</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
  <span class="k">val</span> <span class="n">intForm</span><span class="k">:</span> <span class="kt">WebMonadForm</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

  <span class="c1">// combine the source and the target stacks
</span>  <span class="k">type</span> <span class="kt">CombinedStack</span> <span class="o">=</span> <span class="nc">FxAppend</span><span class="o">[</span><span class="kt">GreasyStack</span>, <span class="kt">PlayStack</span><span class="o">]</span>
  
  <span class="c1">// start from greasyspoon
</span>  <span class="k">val</span> <span class="n">convertedProgram</span> <span class="k">=</span> <span class="n">greasySpoon</span><span class="o">[</span><span class="kt">CombinedStack</span><span class="o">]</span>
        <span class="o">.</span><span class="n">useForm</span><span class="o">(</span><span class="n">intForm</span><span class="o">)</span>      <span class="c1">// map Int fields
</span>        <span class="o">.</span><span class="n">useForm</span><span class="o">(</span><span class="n">booleanForm</span><span class="o">)</span>  <span class="c1">// map Boolean fields
</span>
  <span class="k">def</span> <span class="n">greasy</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">.</span><span class="n">async</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">request</span> <span class="k">=&gt;</span>
  
    <span class="c1">// run our program
</span>    <span class="n">runWeb</span><span class="o">(</span>             
      <span class="n">convertedProgram</span><span class="o">,</span>   
      <span class="n">key</span><span class="o">,</span>
      <span class="n">request</span><span class="o">,</span>
      <span class="n">persistence</span>
    <span class="o">)(</span> <span class="n">a</span> <span class="k">=&gt;</span> 
      <span class="c1">// handle the output
</span>      <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="nc">Ok</span><span class="o">(</span><span class="n">s</span><span class="s">"Your bill is $a groats"</span><span class="o">))</span>
    <span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">key</code> argument is the page the user is requesting, taken from the URI. If
the user is attempting to go back in the journey then uniform knows to render an
old page. If the user tries to skip forward however uniform will not permit them
to advance without answering the requisite questions correctly.</p>

<p>The <code class="highlighter-rouge">request</code> argument is needed to capture the values submitted by the user.</p>

<p>The <code class="highlighter-rouge">persistence</code> argument tells uniform how to store the state of the users
journey.</p>

<p>The <code class="highlighter-rouge">program</code> argument is the most interesting. This takes the webmonad program
to be executed. Our <code class="highlighter-rouge">greasySpoon</code> program must first be converted, intuitively
what we are doing here is telling uniform how each datatype it is interested in
should be obtained from the user.</p>

<p>In practice we first create a new combined monad stack (we have called it
<code class="highlighter-rouge">CombinedStack</code>) using <code class="highlighter-rouge">FxAppend</code> - this stack 
contains everything we are converting from (<code class="highlighter-rouge">GreasyStack</code>) and everything we are
converting to (<code class="highlighter-rouge">PlayStack</code>).</p>

<p>We then apply <code class="highlighter-rouge">intForm</code> and <code class="highlighter-rouge">booleanForm</code> to our <code class="highlighter-rouge">greasySpoon</code> program - each
call of <code class="highlighter-rouge">useForm</code> eliminates a layer of the monad stack by converting it into
monads that exist inside <code class="highlighter-rouge">PlayStack</code> (our target). Once we have eliminated
everything from <code class="highlighter-rouge">GreasyStack</code> the result is then a program we then can run by
calling <code class="highlighter-rouge">runWeb</code>.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/uniform-scala/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'ltbs/uniform-scala'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/uniform-scala/js/main.js"></script></body></html>