<html><head><title>uniform-scala: Play Framework Interpreter</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Luke Tebbs" /><meta name="description" content="Purely functional user-interaction" /><meta name="og:image" content="/uniform-scala/img/poster.png" /><meta name="image" property="og:image" content="/uniform-scala/img/poster.png" /><meta name="og:title" content="uniform-scala: Play Framework Interpreter" /><meta name="title" property="og:title" content="uniform-scala: Play Framework Interpreter" /><meta name="og:site_name" content="uniform-scala" /><meta name="og:url" content="https://ltbs.github.io/uniform-scala/" /><meta name="og:type" content="website" /><meta name="og:description" content="Purely functional user-interaction" /><link rel="icon" type="image/png" href="/uniform-scala/img/favicon.png" /><meta name="twitter:title" content="uniform-scala: Play Framework Interpreter" /><meta name="twitter:image" content="/uniform-scala/img/poster.png" /><meta name="twitter:description" content="Purely functional user-interaction" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/uniform-scala/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/uniform-scala/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/uniform-scala/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/uniform-scala/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/uniform-scala/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/uniform-scala/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/uniform-scala/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/uniform-scala/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/uniform-scala/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/uniform-scala/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/uniform-scala/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/uniform-scala/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/uniform-scala/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/uniform-scala/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/uniform-scala/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/uniform-scala/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/uniform-scala/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/uniform-scala/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/uniform-scala/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/uniform-scala/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/uniform-scala/highlight/styles/color-brewer.css" /><link rel="stylesheet" href="/uniform-scala/css/style.css" /><link rel="stylesheet" href="/uniform-scala/css/palette.css" /><link rel="stylesheet" href="/uniform-scala/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/uniform-scala/" class="brand"><div class="brand-wrapper"><span>uniform-scala</span></div></a></li> <li><a href="/uniform-scala/index.html" class="">Home</a></li> <li><a href="/uniform-scala/setup.html" class="">Setup</a></li> <li><a href="/uniform-scala/core/basic-program.html" class="">Writing a journey</a> <ul class="sub_section"> <li><a href="/uniform-scala/core/tells.html" class="">Telling</a></li> <li><a href="/uniform-scala/core/asks.html" class="">Asking</a></li> <li><a href="/uniform-scala/core/interacts.html" class="">Interacting</a></li> <li><a href="/uniform-scala/core/validation.html" class="">Validation</a></li> <li><a href="/uniform-scala/core/branching.html" class="">Branching</a></li> <li><a href="/uniform-scala/core/remote-calls.html" class="">Remote Calls</a></li></ul></li> <li><a href="/uniform-scala/play/index.html" class=" active ">Play Framework Interpreter</a> <ul class="sub_section"> <li><a href="/uniform-scala/play/controllers.html" class="">Controllers</a></li> <li><a href="/uniform-scala/play/web-monad.html" class="">WebMonad</a></li> <li><a href="/uniform-scala/play/internationalisation.html" class="">Internationalisation</a></li> <li><a href="/uniform-scala/play/listing-pages.html" class="">Listing Pages</a></li> <li><a href="/uniform-scala/play/remote-calls.html" class="">Memoisation</a></li></ul></li> <li><a href="/uniform-scala/interpreters.html" class="">Other Interpreters</a> <ul class="sub_section"> <li><a href="/uniform-scala/other/interpreter-cli.html" class="">CLI Interpreter</a></li> <li><a href="/uniform-scala/other/interpreter-logic-table.html" class="">Logic Table Interpreter</a></li> <li><a href="/uniform-scala/interpreter-static-site.html" class="">Static Site interpreter</a></li> <li><a href="/uniform-scala/interpreter-selenium.html" class="">Selenium Interpreter</a></li></ul></li> <li><a href="/uniform-scala/core/advanced.html" class="">Advanced Options</a> <ul class="sub_section"> <li><a href="/uniform-scala/core/writing-interpreters.html" class="">Writing Interpreters</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/ltbs/uniform-scala"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/ltbs/uniform-scala"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('uniform-scala Purely functional user-interaction');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('uniform-scala Purely functional user-interaction');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="ltbs" data-github-repo="uniform-scala"><div class="content-wrapper"><section><h1 id="play-interpreter">Play Interpreter</h1>

<h2 id="setup">Setup</h2>

<p>If you are using play 2.6 you will need the following dependency in your build.sbt</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libraryDependencies +=
  "com.luketebbs.uniform" %% "interpreter-play26" % "0.5.1"
</code></pre></div></div>

<p>Or if you are using play 2.5 -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>libraryDependencies +=
  "com.luketebbs.uniform" %% "interpreter-play25" % "0.5.1"
</code></pre></div></div>

<h2 id="controller-setup">Controller Setup</h2>

<p>Next you will need to extend your controller using <code class="highlighter-rouge">PlayController</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import ltbs.uniform.interpreters.playframework._
import ltbs.uniform.web._
import ltbs.uniform._

import cats.Monoid
import cats.data.Validated
import cats.implicits._
import concurrent.{Future, ExecutionContext}
import org.atnos.eff._
import play.api._, mvc._, i18n.{Messages =&gt; _, _}
import play.api.data._, Forms._
import play.twirl.api.Html
import javax.inject._

@Singleton
class ExampleController @Inject()(implicit val messagesApi: MessagesApi) extends Controller with PlayInterpreter with I18nSupport {

  def messages(request: Request[AnyContent]): Messages =
    convertMessages(messagesApi.preferred(request))

  def renderForm(
    key: List[String],
	errors: ErrorTree,
	form: Html,
	breadcrumbs: List[String],
	request: Request[AnyContent],
	messages: Messages
  ): Html = ???

}
</code></pre></div></div>

<p>This makes the common play interpreter available.</p>

<p>The <code class="highlighter-rouge">messages</code> method is used for internationalisation, if you are
using the play messages you can convert them using the
<code class="highlighter-rouge">convertMessages</code> function. It is also possible to use <code class="highlighter-rouge">NoopMessages</code>
which simply returns the message key - this is rarely useful however as
even with monolingual you will likely want to supply titles, content
and error messages rather than use the text generated from uniform
(for example if you have a field called <code class="highlighter-rouge">userAge</code> it will literally
label the field with that).</p>

<p><code class="highlighter-rouge">renderForm</code> is used for the ‘chrome’ around the form - i.e. all the
other HTML. Typically this will be a call to the main template view.</p>

<p>Once these are in place you will need to tell uniform how to ask the
user for all the datatypes you have in the program stack. For this you
need to supply an instance of the <code class="highlighter-rouge">PlayForm</code> trait. For example if we
wanted to handle allowing the user to input a <code class="highlighter-rouge">String</code> you can enter
the following -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val myForm = new PlayForm[String] {

}
</code></pre></div></div>

<p>These are contained in
the <code class="highlighter-rouge">WebMonadForm</code> class. If we use the
<code class="highlighter-rouge">GreasySpoon</code> program from the examples we need to be able to ask the user for
an <code class="highlighter-rouge">Int</code> and for a <code class="highlighter-rouge">Boolean</code> and as such we must provide an instance of
<code class="highlighter-rouge">WebMonadForm[Int]</code> and <code class="highlighter-rouge">WebMonadForm[Boolean]</code>. <code class="highlighter-rouge">WebMonadForm</code> has the
following structure -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trait WebMonadForm[T] {
  def encode(in: T): Encoded
  def decode(out: Encoded): T

  def playForm(
    key: String,
    validation: T =&gt; Validated[ValidationError, T]
  ): Form[T]

  def render(
    key: String,
    existing: ValidatedData[T],
    request: Request[AnyContent]
  ): Html
}
</code></pre></div></div>

<p><code class="highlighter-rouge">Encoded</code> is just a type-alias for <code class="highlighter-rouge">String</code>. <code class="highlighter-rouge">encode</code> and <code class="highlighter-rouge">decode</code> are necessary so that uniform
can persist the data between requests. You could use Java serialisation here,
JSON encoding using <code class="highlighter-rouge">play-json</code> or perhaps one of the Scala pickling libraries.
For simplicity here we’ll just roll our own.</p>

<p><code class="highlighter-rouge">render</code> defines how the form should appear, and <code class="highlighter-rouge">playForm</code> defines how the form
(and mapping) should be defined, and also how to hook in any validation defined
in the uniform journey itself.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ExampleController2 @Inject()(implicit val messagesApi: MessagesApi) extends Controller with PlayInterpreter with I18nSupport {
  import ltbs.uniform.sampleprograms.GreasySpoon._

  val booleanForm = new WebMonadForm[Boolean] {

    def decode(out: Encoded): Boolean = out == "true"
    def encode(in: Boolean): Encoded = in.toString

    def playForm(
      key: String,
      validation: Boolean =&gt; Validated[ValidationError,Boolean]
    ): Form[Boolean] = Form(single(key -&gt; boolean))

    def render(
      key: String,
      existing: ValidatedData[Boolean],
      request: Request[AnyContent]
    ): Html = {
      val form = existing match {
        case Some(Validated.Invalid(e)) =&gt; Form(single(key -&gt; boolean)).withError("", e)
        case _ =&gt; Form(single(key -&gt; boolean))
      }

      ??? // replace with your view
    }
  }

  val intForm: WebMonadForm[Int] = ???

}
</code></pre></div></div>

<p>Next we need a persistence provider. Ordinarily we’d have something keyed
against the session, or perhaps the users credentials if they are logged in.
This can be used to provide the capabilities for the user to log out and come
back later. For testing purposes however we’ll just use a crude in-memory map.</p>

<p>Note that this combines data between ALL users - for obvious reasons you
shouldn’t do this for a real service.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type DB = Map[String,String]

def persistence(implicit ec: ExecutionContext) = new Persistence {
  private var data: DB = Monoid[DB].empty
  def dataGet: Future[DB] = Future.successful(data)
  def dataPut(dataIn: DB): Future[Unit] =
    Future(data = dataIn).map{_ =&gt; ()}
}
</code></pre></div></div>

<p>Now we have our persistence mechanism, we can construct the actual journey as
needed -</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ExampleController3(
  implicit val ec: ExecutionContext
) extends Controller with PlayInterpreter {

  import ltbs.uniform.sampleprograms.GreasySpoon._

  val booleanForm: WebMonadForm[Boolean] = ???
  val intForm: WebMonadForm[Int] = ???

  // combine the source and the target stacks
  type CombinedStack = FxAppend[GreasyStack, PlayStack]

  // start from greasyspoon
  val convertedProgram = greasySpoon[CombinedStack]
        .useForm(intForm)      // map Int fields
        .useForm(booleanForm)  // map Boolean fields

  def greasy(key: String) = Action.async { implicit request =&gt;

    // run our program
    runWeb(
      convertedProgram,
      key,
      request,
      persistence
    )( a =&gt;
      // handle the output
      Future.successful(Ok(s"Your bill is $a groats"))
    )
  }

}
</code></pre></div></div>

<p>The <code class="highlighter-rouge">key</code> argument is the page the user is requesting, taken from the URI. If
the user is attempting to go back in the journey then uniform knows to render an
old page. If the user tries to skip forward however uniform will not permit them
to advance without answering the requisite questions correctly.</p>

<p>The <code class="highlighter-rouge">request</code> argument is needed to capture the values submitted by the user.</p>

<p>The <code class="highlighter-rouge">persistence</code> argument tells uniform how to store the state of the users
journey.</p>

<p>The <code class="highlighter-rouge">program</code> argument is the most interesting. This takes the webmonad program
to be executed. Our <code class="highlighter-rouge">greasySpoon</code> program must first be converted, intuitively
what we are doing here is telling uniform how each datatype it is interested in
should be obtained from the user.</p>

<p>In practice we first create a new combined monad stack (we have called it
<code class="highlighter-rouge">CombinedStack</code>) using <code class="highlighter-rouge">FxAppend</code> - this stack
contains everything we are converting from (<code class="highlighter-rouge">GreasyStack</code>) and everything we are
converting to (<code class="highlighter-rouge">PlayStack</code>).</p>

<p>We then apply <code class="highlighter-rouge">intForm</code> and <code class="highlighter-rouge">booleanForm</code> to our <code class="highlighter-rouge">greasySpoon</code> program - each
call of <code class="highlighter-rouge">useForm</code> eliminates a layer of the monad stack by converting it into
monads that exist inside <code class="highlighter-rouge">PlayStack</code> (our target). Once we have eliminated
everything from <code class="highlighter-rouge">GreasyStack</code> the result is then a program we then can run by
calling <code class="highlighter-rouge">runWeb</code>.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/uniform-scala/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/uniform-scala/js/main.js"></script></body></html>